name: Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g. 1.0.0)"
        required: true
        default: "1.0.0"
      release_notes:
        description: "Release notes"
        required: false
        default: ""

jobs:
  build:
    name: Build macOS App (Apple Silicon)
    runs-on: macos-15-xlarge  # Apple Silicon (M-series) runner

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_16.3.app

      - name: Show build environment
        run: |
          xcodebuild -version
          swift --version
          xcodebuild -project LinuxVMCreator.xcodeproj -list

      - name: Verify ARM64 runner
        run: |
          arch
          uname -m
          [[ "$(uname -m)" == "arm64" ]] || { echo "Error: not running on Apple Silicon"; exit 1; }

      - name: Build
        run: |
          xcodebuild build \
            -project LinuxVMCreator.xcodeproj \
            -scheme LinuxVMCreator \
            -configuration Release \
            -destination "platform=macOS,arch=arm64" \
            -derivedDataPath build/DerivedData \
            ARCHS=arm64 \
            ONLY_ACTIVE_ARCH=NO \
            EXCLUDED_ARCHS=x86_64 \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty || xcodebuild build \
              -project LinuxVMCreator.xcodeproj \
              -scheme LinuxVMCreator \
              -configuration Release \
              -destination "platform=macOS,arch=arm64" \
              -derivedDataPath build/DerivedData \
              ARCHS=arm64 \
              ONLY_ACTIVE_ARCH=NO \
              EXCLUDED_ARCHS=x86_64 \
              CODE_SIGNING_ALLOWED=NO

      - name: Locate built app
        id: locate
        run: |
          APP=$(find build/DerivedData -name "LinuxVMCreator.app" -type d | head -1)
          echo "app_path=$APP" >> $GITHUB_OUTPUT
          echo "Found: $APP"

      - name: Create ZIP archive
        run: |
          cd "$(dirname "${{ steps.locate.outputs.app_path }}")"
          zip -qr "$GITHUB_WORKSPACE/LinuxVMCreator-arm64-unsigned.zip" LinuxVMCreator.app
          echo "Archive size: $(du -sh "$GITHUB_WORKSPACE/LinuxVMCreator-arm64-unsigned.zip" | cut -f1)"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: LinuxVMCreator-arm64-unsigned
          path: LinuxVMCreator-arm64-unsigned.zip
          retention-days: 30

      - name: Create GitHub Release
        if: github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: LinuxVMCreator v${{ github.event.inputs.version }}
          body: |
            ## LinuxVMCreator v${{ github.event.inputs.version }}

            ${{ github.event.inputs.release_notes }}

            ### Installation
            > ⚠️ This build is **unsigned**. To run it:
            > ```
            > xattr -dr com.apple.quarantine LinuxVMCreator.app
            > ```
            > Or go to **System Settings → Privacy & Security** and click "Open Anyway".

            ### Requirements
            - macOS 14.0 (Sonoma) or later
            - **Apple Silicon (M1 or newer) — ARM64 only, x86_64 not supported**
          files: LinuxVMCreator-arm64-unsigned.zip
          draft: false
          prerelease: false
